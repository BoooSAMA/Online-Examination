@page "/admin-dashboard"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@inject ExamService ExamService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

@using Online_Examination.Services
@using Online_Examination.Domain
@using Microsoft.JSInterop

<PageTitle>Admin Dashboard | Examination Board</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-dark">
                <i class="bi bi-speedometer2"></i> Admin Dashboard
            </h1>
            <p class="text-muted">Welcome back, Administrator</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-3 text-dark">
                <i class="bi bi-lightning-charge-fill text-warning"></i> Quick Actions
            </h3>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6 col-lg-4 mb-3">
            <a href="/admin/exam-create" class="text-decoration-none">
                <div class="card border-0 shadow-sm h-100 hover-lift" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-plus-circle-fill text-white mb-3" style="font-size: 3rem;"></i>
                        <h4 class="text-white mb-2">Create New Exam</h4>
                        <p class="text-white mb-3" style="opacity: 0.9;">Design and publish a new examination</p>
                        <span class="btn btn-light btn-lg px-4">
                            <i class="bi bi-pencil-square"></i> Create Exam
                        </span>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-6 col-lg-4 mb-3">
            <a href="/exam-index" class="text-decoration-none">
                <div class="card border-0 shadow-sm h-100 hover-lift" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-list-check text-white mb-3" style="font-size: 3rem;"></i>
                        <h4 class="text-white mb-2">Manage Exams</h4>
                        <p class="text-white mb-3" style="opacity: 0.9;">View, edit, or delete existing exams</p>
                        <span class="btn btn-light btn-lg px-4">
                            <i class="bi bi-folder-open"></i> View Exams
                        </span>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-6 col-lg-4 mb-3">
            <a href="/modify-students" class="text-decoration-none">
                <div class="card border-0 shadow-sm h-100 hover-lift" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-people-fill text-white mb-3" style="font-size: 3rem;"></i>
                        <h4 class="text-white mb-2">Manage Students</h4>
                        <p class="text-white mb-3" style="opacity: 0.9;">View and manage student accounts</p>
                        <span class="btn btn-light btn-lg px-4">
                            <i class="bi bi-person-gear"></i> View Students
                        </span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-3 text-dark">
                <i class="bi bi-graph-up text-success"></i> Statistics Overview
            </h3>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3">
            <a href="/exam-index" class="text-decoration-none">
                <div class="card border-0 shadow-sm h-100 bg-white hover-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <p class="text-muted mb-1 small text-uppercase fw-bold">TOTAL EXAMS</p>
                                @if (isLoadingStats)
                                {
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                }
                                else
                                {
                                    <h2 class="mb-0 fw-bold text-dark">@totalExams</h2>
                                }
                            </div>
                            <div class="bg-primary bg-opacity-10 rounded p-3">
                                <i class="bi bi-journal-text text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                        </div>
                        <small class="text-muted"><i class="bi bi-check-circle text-success"></i> @publishedExams Published</small>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-6 col-lg-3 mb-3">
            <a href="/admin/global-history" class="text-decoration-none">
                <div class="card border-0 shadow-sm h-100 bg-white hover-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <p class="text-muted mb-1 small text-uppercase fw-bold">TOTAL ATTEMPTS</p>
                                @if (isLoadingStats)
                                {
                                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                                }
                                else
                                {
                                    <h2 class="mb-0 fw-bold text-dark">@totalAttempts</h2>
                                }
                            </div>
                            <div class="bg-success bg-opacity-10 rounded p-3">
                                <i class="bi bi-clipboard-check text-success" style="font-size: 1.5rem;"></i>
                            </div>
                        </div>
                        <small class="text-muted"><i class="bi bi-people text-primary"></i> Student submissions</small>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-muted mb-1 small text-uppercase fw-bold">TOTAL QUESTIONS</p>
                            @if (isLoadingStats)
                            {
                                <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                            }
                            else
                            {
                                <h2 class="mb-0 fw-bold text-dark">@totalQuestions</h2>
                            }
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded p-3">
                            <i class="bi bi-question-circle text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <small class="text-muted"><i class="bi bi-list-ul text-secondary"></i> Across all exams</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-3">
            <a href="/admin/global-history" class="text-decoration-none">
                <div class="card border-0 shadow-sm h-100 bg-white hover-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <p class="text-muted mb-1 small text-uppercase fw-bold">AVERAGE SCORE</p>
                                @if (isLoadingStats)
                                {
                                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                                }
                                else
                                {
                                    <h2 class="mb-0 fw-bold text-dark">@averageScore%</h2>
                                }
                            </div>
                            <div class="bg-info bg-opacity-10 rounded p-3">
                                <i class="bi bi-graph-up-arrow text-info" style="font-size: 1.5rem;"></i>
                            </div>
                        </div>
                        <small class="text-muted"><i class="bi bi-trophy text-warning"></i> Overall performance</small>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-3 text-dark">
                <i class="bi bi-graph-up text-success"></i> Advanced Analytics
            </h3>

            <!-- Refresh Button -->
            @if (totalAttempts > 0)
            {
                <div class="mb-3">
                    <button class="btn btn-outline-primary btn-sm" @onclick="ManualRefreshCharts" disabled="@isRefreshing">
                        @if (isRefreshing)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>Refreshing...</span>
                        }
                        else
                        {
                            <i class="bi bi-arrow-clockwise"></i>
                            <span>Refresh</span>
                        }
                    </button>
                    @if (!string.IsNullOrEmpty(refreshMessage))
                    {
                        <small class="ms-2 text-success">@refreshMessage</small>
                    }
                </div>
            }
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm bg-white">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-pie-chart-fill text-primary"></i> Performance Distribution
                    </h5>
                </div>
                <div class="card-body">
                    @if (isLoadingStats)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3 text-muted">Analyzing performance...</p>
                        </div>
                    }
                    else if (totalAttempts == 0)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No data yet. Charts appear after students take exams.
                        </div>
                    }
                    else
                    {
                        <div style="height: 350px;" class="@(hasChartData ? "" : "d-none")">
                            <canvas id="adminPieChart"></canvas>
                        </div>
                        @if (!hasChartData)
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Not enough data for chart.
                            </div>
                        }
                        else
                        {
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Based on @totalAttempts attempts
                                </small>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm bg-white">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-graph-up-arrow text-success"></i> Score Trend Over Time
                    </h5>
                </div>
                <div class="card-body">
                    @if (isLoadingStats)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status"></div>
                            <p class="mt-3 text-muted">Calculating trends...</p>
                        </div>
                    }
                    else if (totalAttempts == 0)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Not enough data for trend analysis.
                        </div>
                    }
                    else
                    {
                        <div style="height: 350px;" class="@(hasChartData ? "" : "d-none")">
                            <canvas id="adminLineChart"></canvas>
                        </div>
                        @if (!hasChartData)
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Not enough data for trend.
                            </div>
                        }
                        else
                        {
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> Last @trendData.Count days
                                </small>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }

    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
    }

    .hover-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }

    .hover-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2) !important;
    }

    a.text-decoration-none {
        color: inherit;
        display: block;
    }

    a.text-decoration-none:hover {
        text-decoration: none !important;
    }

    .card-body * {
        pointer-events: none;
    }

    .card-body {
        pointer-events: auto;
    }
</style>

@code {
    private int totalExams = 0;
    private int publishedExams = 0;
    private int totalAttempts = 0;
    private int totalQuestions = 0;
    private int averageScore = 0;
    private bool isLoadingStats = true;
    private bool isRefreshing = false;
    private bool hasChartData = false;
    private string refreshMessage = "";
    private Dictionary<string, int> performanceData = new();
    private Dictionary<string, double> trendData = new();
    private List<Attempt> allAttempts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine($"[AdminDashboard] OnAfterRenderAsync - firstRender");
            Console.WriteLine($"[AdminDashboard] Has chart data: {hasChartData}");
            Console.WriteLine($"[AdminDashboard] Total attempts: {totalAttempts}");
            Console.WriteLine($"[AdminDashboard] Performance data count: {performanceData.Count}");
            Console.WriteLine($"[AdminDashboard] Trend data count: {trendData.Count}");

            if (hasChartData)
            {
                await Task.Delay(100);
                await RenderCharts();
            }
            else
            {
                Console.WriteLine($"[AdminDashboard] ?? No chart data to render.");
            }
        }
    }

    private async Task ManualRefreshCharts()
    {
        try
        {
            isRefreshing = true;
            refreshMessage = "";
            StateHasChanged();

            Console.WriteLine($"[AdminDashboard] ?? Manual refresh triggered");
            Console.WriteLine($"[AdminDashboard] Total Attempts: {totalAttempts}");
            Console.WriteLine($"[AdminDashboard] Has Chart Data: {hasChartData}");

            if (!hasChartData)
            {
                Console.WriteLine($"[AdminDashboard] ?? No chart data available for rendering");
                refreshMessage = "No data available for charts";
                return;
            }

            // Small delay to ensure UI updates
            await Task.Delay(200);

            // Attempt to render charts
            await RenderCharts();

            refreshMessage = "? Charts refreshed successfully!";
            Console.WriteLine($"[AdminDashboard] ? Manual refresh completed successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[AdminDashboard] ? Manual refresh error: {ex.Message}");
            refreshMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();

            // Clear message after 3 seconds
            await Task.Delay(3000);
            refreshMessage = "";
            StateHasChanged();
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            isLoadingStats = true;
            Console.WriteLine("[AdminDashboard] Starting to load dashboard data...");

            var exams = await ExamService.GetAllExamsAsync();
            totalExams = exams.Count;
            publishedExams = exams.Count(e => e.IsPublished);
            totalQuestions = exams.Sum(e => e.Questions?.Count ?? 0);

            Console.WriteLine($"[AdminDashboard] Total exams: {totalExams}");
            Console.WriteLine($"[AdminDashboard] Published exams: {publishedExams}");
            Console.WriteLine($"[AdminDashboard] Total questions: {totalQuestions}");

            allAttempts = new List<Attempt>();
            foreach (var exam in exams)
            {
                if (exam.Attempts != null)
                {
                    allAttempts.AddRange(exam.Attempts);
                }
            }

            totalAttempts = allAttempts.Count;
            Console.WriteLine($"[AdminDashboard] ? Total attempts collected: {totalAttempts}");

            if (totalAttempts == 0)
            {
                Console.WriteLine($"[AdminDashboard] ?? WARNING: No attempts found!");
                Console.WriteLine($"[AdminDashboard] Charts will not be displayed until students take exams.");
            }

            if (allAttempts.Any())
            {
                var gradeGroups = allAttempts
                    .Where(a => a.Exam?.Questions != null && a.Exam.Questions.Any())
                    .Select(a => new { Percentage = (double)a.Score / a.Exam.Questions.Count * 100 })
                    .GroupBy(x => x.Percentage >= 80 ? "Excellent (A)" : x.Percentage >= 60 ? "Good (B)" : x.Percentage >= 50 ? "Pass (C)" : "Fail (F)")
                    .ToDictionary(g => g.Key, g => g.Count());

                performanceData = gradeGroups;
                Console.WriteLine($"[AdminDashboard] Performance Data: {string.Join(", ", performanceData.Select(x => $"{x.Key}={x.Value}"))}");

                var trendGroups = allAttempts
                    .Where(a => a.Exam?.Questions != null && a.Exam.Questions.Any())
                    .GroupBy(a => a.DateCreated.Date)
                    .Select(g => new { Date = g.Key, AvgScore = g.Average(a => (double)a.Score / a.Exam.Questions.Count * 100) })
                    .OrderBy(x => x.Date)
                    .Take(10)
                    .ToDictionary(x => x.Date.ToString("MMM dd"), x => x.AvgScore);

                trendData = trendGroups;
                Console.WriteLine($"[AdminDashboard] Trend Data: {string.Join(", ", trendData.Select(x => $"{x.Key}={x.Value:F1}"))}");

                hasChartData = performanceData.Any() && trendData.Any();
                Console.WriteLine($"[AdminDashboard] Has chart data: {hasChartData}");

                if (!hasChartData)
                {
                    Console.WriteLine($"[AdminDashboard] ?? WARNING: Insufficient data for charts");
                    Console.WriteLine($"[AdminDashboard]   - Performance data entries: {performanceData.Count}");
                    Console.WriteLine($"[AdminDashboard]   - Trend data entries: {trendData.Count}");
                }

                var totalPossibleScore = allAttempts.Where(a => a.Exam?.Questions != null).Sum(a => a.Exam.Questions.Count);
                var totalActualScore = allAttempts.Sum(a => a.Score);
                if (totalPossibleScore > 0)
                {
                    averageScore = (int)Math.Round((double)totalActualScore / totalPossibleScore * 100);
                }

                Console.WriteLine($"[AdminDashboard] Average score: {averageScore}%");
            }
            else
            {
                Console.WriteLine("[AdminDashboard] No attempts found (empty list).");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[AdminDashboard] ? ERROR loading dashboard data: {ex.Message}");
            Console.WriteLine($"[AdminDashboard] Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isLoadingStats = false;
            Console.WriteLine("[AdminDashboard] Finished loading dashboard data.");
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            Console.WriteLine("[AdminDashboard] ?? Starting to render charts...");
            Console.WriteLine($"[AdminDashboard] Performance data: {performanceData.Count} entries");
            Console.WriteLine($"[AdminDashboard] Trend data: {trendData.Count} entries");

            if (performanceData.Any())
            {
                Console.WriteLine($"[AdminDashboard] Rendering pie chart with {performanceData.Count} data points");
                
                var pieLabels = performanceData.Keys.ToArray();
                var pieData = performanceData.Values.ToArray();
                var pieColors = new[] { "rgba(75, 192, 192, 0.8)", "rgba(54, 162, 235, 0.8)", "rgba(255, 206, 86, 0.8)", "rgba(255, 99, 132, 0.8)" };

                Console.WriteLine($"[AdminDashboard] Pie labels: {string.Join(", ", pieLabels)}");
                Console.WriteLine($"[AdminDashboard] Pie data: {string.Join(", ", pieData)}");

                try
                {
                    await JSRuntime.InvokeVoidAsync("renderChart", "adminPieChart", "pie", pieLabels, pieData, "Performance Distribution", pieColors);
                    Console.WriteLine("[AdminDashboard] ? Pie chart rendered successfully");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[AdminDashboard] ? Error rendering pie chart: {ex.Message}");
                    throw;
                }
            }
            else
            {
                Console.WriteLine("[AdminDashboard] ?? No performance data to render pie chart");
            }

            if (trendData.Any())
            {
                Console.WriteLine($"[AdminDashboard] Rendering line chart with {trendData.Count} data points");
                
                var lineLabels = trendData.Keys.ToArray();
                var lineData = trendData.Values.ToArray();
                var lineColors = new[] { "rgba(78, 115, 223, 0.2)" };

                Console.WriteLine($"[AdminDashboard] Line labels: {string.Join(", ", lineLabels)}");
                Console.WriteLine($"[AdminDashboard] Line data: {string.Join(", ", lineData.Select(d => d.ToString("F1")))}");

                try
                {
                    await JSRuntime.InvokeVoidAsync("renderChart", "adminLineChart", "line", lineLabels, lineData, "Average Score Trend", lineColors);
                    Console.WriteLine("[AdminDashboard] ? Line chart rendered successfully");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[AdminDashboard] ? Error rendering line chart: {ex.Message}");
                    throw;
                }
            }
            else
            {
                Console.WriteLine("[AdminDashboard] ?? No trend data to render line chart");
            }

            Console.WriteLine("[AdminDashboard] ? Finished rendering charts.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[AdminDashboard] ? FATAL ERROR in RenderCharts: {ex.Message}");
            Console.WriteLine($"[AdminDashboard] Stack trace: {ex.StackTrace}");
            throw;
        }
    }
}
